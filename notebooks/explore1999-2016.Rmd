---
title: "Explore 1999-2016 Harvest Data"
output: html_notebook
---

```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r setup}
setwd("C:/Dev/Projects/CafPlantGridPointSurvey/R/AggregateYieldAndBiomass_1999-2016")
library(tidyverse)
library(plotly)

source("src/functions.R")
source("src/cleaningFunctions.R")

df <- get_clean1999_2016()
```




# Summary by year and crop
```{r}
df.summary <- df %>% 
  filter(!is.na(GrainYieldDryPerArea)) %>% 
  group_by(HarvestYear, Crop) %>% 
  summarize(meanYield = mean(GrainYieldDryPerArea, na.rm = TRUE),
            maxYield = max(GrainYieldDryPerArea, na.rm = TRUE),
            minYield = min(GrainYieldDryPerArea, na.rm = TRUE))

#df.summary %>% print(n = 15)

p <- df.summary %>% 
  ggplot(aes(x = HarvestYear, y = meanYield)) +
    geom_ribbon(aes(x = HarvestYear, ymax = maxYield, ymin = minYield), alpha = 0.6, fill = "grey") +
    geom_line() +
    geom_point(size = 1) +
    facet_wrap(~ Crop) +
    theme(panel.grid.minor = element_line(color = "white", size = 0.1)) +
    scale_x_continuous(minor_breaks = seq(1999, 2016, 1)) +
    labs(x = "harvest year", y = "mean yield (g / m2)")
ggplotly(p)
```

```{r}
p <- df %>% 
  filter(!is.na(ResidueMassDryPerArea)) %>% 
  ggplot(aes(x = as.factor(HarvestYear), y = ResidueMassDryPerArea), na.rm = TRUE) +
  geom_boxplot() +  
    facet_wrap(~ Crop) +
    theme(axis.text.x = element_text(angle = 90)) +
    labs(x = "harvest year", y = "mean residue (g / m2)")
ggplotly(p)
#p
```

```{r}
df.summary <- df %>% 
  filter(!is.na(ResidueMassDryPerArea) & !is.na(GrainYieldDryPerArea)) %>% 
  mutate(HarvestIndex = GrainYieldDryPerArea / (GrainYieldDryPerArea + ResidueMassDryPerArea)) %>% 
  group_by(HarvestYear, Crop) %>% 
  summarize(meanHarvestIndex = mean(HarvestIndex, na.rm = TRUE),
            maxHarvestIndex = max(HarvestIndex, na.rm = TRUE),
            minHarvestIndex = min(HarvestIndex, na.rm = TRUE))

#df.summary %>% print(n = 15)

p <- df.summary %>% 
  ggplot(aes(x = as.factor(HarvestYear), y = meanHarvestIndex)) +
    geom_boxplot() +
    #geom_ribbon(aes(x = HarvestYear, ymax = maxHarvestIndex, ymin = minHarvestIndex), alpha = 0.6, fill = "grey") +
    #geom_line() +
    #geom_point(size = 1) +
    facet_wrap(~ Crop) +
    #theme(panel.grid.minor = element_line(color = "white", size = 0.1)) +
    #scale_x_continuous(minor_breaks = seq(1999, 2016, 1)) +
    labs(x = "harvest year", y = "mean harvest index")
p
#ggplotly(p)
```

```{r}
df.summary <- df %>% 
  filter(!is.na(ResidueMassDryPerArea) & !is.na(GrainYieldDryPerArea)) %>% 
  mutate(HarvestIndex = GrainYieldDryPerArea / (GrainYieldDryPerArea + ResidueMassDryPerArea),
         YearFactor = as.factor(HarvestYear)) %>% 
  group_by(HarvestYear, Crop) %>% 
  summarize(meanHarvestIndex = mean(HarvestIndex, na.rm = TRUE),
            maxHarvestIndex = max(HarvestIndex, na.rm = TRUE),
            minHarvestIndex = min(HarvestIndex, na.rm = TRUE))

#df.summary %>% print(n = 15)

p <- df.summary %>% 
  ggplot(aes(x = as.factor(HarvestYear), y = meanHarvestIndex)) +
    geom_boxplot() +
    facet_wrap(~ Crop) +
    labs(x = "harvest year", y = "mean harvest index")
#p
ggplotly(p)
```